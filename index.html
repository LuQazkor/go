<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
<title>GLB World v10 – Better Controls</title>
<style>
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:#000}
#c{width:100vw;height:100vh;display:block}
#hud{
  position:fixed;top:10px;left:10px;z-index:10;
  color:#fff;font:13px system-ui;
  background:rgba(0,0,0,.7);padding:10px;border-radius:10px
}
#mobile{position:fixed;left:0;right:0;bottom:0;pointer-events:none}
.pad{
  pointer-events:auto;position:absolute;bottom:20px;
  width:140px;height:140px;border-radius:999px;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.2)
}
#leftPad{left:20px}
#rightPad{right:20px}
.stick{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  width:56px;height:56px;border-radius:999px;
  background:rgba(255,255,255,.25)
}
</style>
</head>
<body>

<div id="hud">
  <b>v10 Controls</b><br>
  WASD move · Mouse look · Shift sprint<br>
  F = fly toggle · E/Q up/down
</div>

<div id="mobile">
  <div id="leftPad" class="pad"><div id="leftStick" class="stick"></div></div>
  <div id="rightPad" class="pad"><div id="rightStick" class="stick"></div></div>
</div>

<canvas id="c"></canvas>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<script>
const canvas = document.getElementById("c");
const engine = new BABYLON.Engine(canvas,true);
const scene = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color4(0.04,0.1,0.12,1);

// Light
new BABYLON.HemisphericLight("h",new BABYLON.Vector3(0,1,0),scene).intensity=1.2;

// Camera
const cam = new BABYLON.FollowCamera("cam",new BABYLON.Vector3(0,3,-8),scene);
cam.radius = 8;
cam.heightOffset = 2.2;
cam.rotationOffset = 180;
cam.cameraAcceleration = 0.05;
cam.maxCameraSpeed = 20;
cam.attachControl(canvas,true);
scene.activeCamera = cam;

// Ground
BABYLON.MeshBuilder.CreateGround("g",{width:500,height:500},scene);

// Avatar placeholder
const avatar = BABYLON.MeshBuilder.CreateCapsule("av",{height:1.8},scene);
avatar.position.y = 0.9;
cam.lockedTarget = avatar;

// ---------- INPUT STATE ----------
let yaw = 0;
let pitch = 0;
let flyMode = false;
let velocity = BABYLON.Vector3.Zero();
let move = {x:0,z:0,y:0};
let look = {x:0,y:0};

// Keyboard
const keys = new Set();
window.addEventListener("keydown",e=>{
  keys.add(e.code);
  if(e.code==="KeyF") flyMode=!flyMode;
});
window.addEventListener("keyup",e=>keys.delete(e.code));

// Mouse look
let pointerLocked=false;
canvas.addEventListener("pointerdown",()=>canvas.requestPointerLock());
document.addEventListener("pointerlockchange",()=>pointerLocked=document.pointerLockElement===canvas);
document.addEventListener("mousemove",e=>{
  if(pointerLocked){
    look.x += e.movementX * 0.002;
    look.y += e.movementY * 0.002;
  }
});

// Mobile pads
function setupPad(pad,stick,cb){
  let active=false,id=null;
  pad.addEventListener("pointerdown",e=>{
    active=true;id=e.pointerId;pad.setPointerCapture(id);
  });
  pad.addEventListener("pointermove",e=>{
    if(!active||e.pointerId!==id) return;
    const r=pad.getBoundingClientRect();
    const dx=(e.clientX-(r.left+r.width/2))/(r.width/2);
    const dy=(e.clientY-(r.top+r.height/2))/(r.height/2);
    cb(Math.max(-1,Math.min(1,dx)),Math.max(-1,Math.min(1,dy)));
    stick.style.transform=`translate(${dx*40}px,${dy*40}px)`;
  });
  pad.addEventListener("pointerup",()=>{active=false;cb(0,0);stick.style.transform="translate(-50%,-50%)"});
}
setupPad(leftPad,leftStick,(x,y)=>{move.x=x;move.z=-y});
setupPad(rightPad,rightStick,(x,y)=>{look.x+=x*0.05;look.y+=y*0.05});

// ---------- UPDATE LOOP ----------
scene.onBeforeRenderObservable.add(()=>{
  const dt = Math.min(0.05,engine.getDeltaTime()/1000);

  // Keyboard movement
  move.z += (keys.has("KeyW")?1:0) - (keys.has("KeyS")?1:0);
  move.x += (keys.has("KeyD")?1:0) - (keys.has("KeyA")?1:0);
  move.y += (keys.has("KeyE")?1:0) - (keys.has("KeyQ")?1:0);

  // Look
  yaw -= look.x;
  pitch = BABYLON.Scalar.Clamp(pitch - look.y, -1.2, 1.2);
  look.x=look.y=0;

  avatar.rotationQuaternion = BABYLON.Quaternion.FromEulerAngles(0,yaw,0);

  // Direction vectors
  const fwd = new BABYLON.Vector3(Math.sin(yaw),0,Math.cos(yaw));
  const right = new BABYLON.Vector3(fwd.z,0,-fwd.x);

  let dir = fwd.scale(move.z).add(right.scale(move.x));
  if(dir.lengthSquared()>1e-4) dir.normalize();

  const baseSpeed = keys.has("ShiftLeft") ? 10 : 5;
  velocity = BABYLON.Vector3.Lerp(velocity, dir.scale(baseSpeed), 0.15);

  avatar.position.addInPlace(velocity.scale(dt));
  if(flyMode) avatar.position.y += move.y * 4 * dt;

  move.x=move.z=move.y=0;
});

engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
