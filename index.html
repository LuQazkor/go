<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>ICU Third-Person Mobile</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<style>
html, body {
  width: 100%;
  height: 100%;
  margin: 0;
  overflow: hidden;
  background: #000;
}
#renderCanvas {
  width: 100%;
  height: 100%;
  touch-action: none;
}
</style>
</head>

<body>
<canvas id="renderCanvas"></canvas>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);

const scene = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color4(0.05,0.07,0.08,1);

// LIGHT
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

// CAMERA â€” Babylon official controller
const camera = new BABYLON.UniversalCamera(
  "cam",
  new BABYLON.Vector3(0, 1.6, -4),
  scene
);
camera.attachControl(canvas, true);
camera.speed = 0.15;
camera.angularSensibility = 4000;
camera.minZ = 0.05;

// Mobile-friendly inputs
camera.inputs.clear();
camera.inputs.addTouch();
camera.inputs.addVirtualJoystick();

// FLOOR (temp visual reference)
const ground = BABYLON.MeshBuilder.CreateGround(
  "ground",
  { width: 20, height: 20 },
  scene
);
ground.isVisible = false;

// LOAD ICU ROOM
BABYLON.SceneLoader.ImportMesh(
  "",
  "./glb/",
  "ICU.glb",
  scene,
  (meshes) => {
    meshes.forEach(m => {
      m.scaling.scaleInPlace(1);
    });
  }
);

// LOAD AVATAR
BABYLON.SceneLoader.ImportMesh(
  "",
  "./glb/",
  "avatar.glb",
  scene,
  (meshes) => {
    const avatarRoot = new BABYLON.TransformNode("avatarRoot", scene);

    meshes.forEach(m => {
      m.parent = avatarRoot;
      m.isPickable = false;
    });

    // NORMALIZE SIZE
    avatarRoot.scaling.scaleInPlace(0.01);

    // PLACE ON FLOOR
    avatarRoot.position = new BABYLON.Vector3(0, 0, 0);

    // CAMERA FOLLOW (3rd person)
    scene.onBeforeRenderObservable.add(() => {
      const forward = camera.getDirection(BABYLON.Axis.Z);
      camera.position = avatarRoot.position
        .add(new BABYLON.Vector3(0, 1.6, 0))
        .subtract(forward.scale(3));
    });
  }
);

engine.runRenderLoop(() => {
  scene.render();
});

window.addEventListener("resize", () => engine.resize());
</script>
</body>
</html>
